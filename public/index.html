<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vibe Edutainment</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Space Grotesk', sans-serif; 
            background-color: #0f172a; 
            color: white;
            width: 100%;
            height: 100vh;
            overflow: hidden;
        }
        #root { width: 100%; height: 100vh; }
        .glass-panel { 
            background: rgba(255, 255, 255, 0.05); 
            backdrop-filter: blur(10px); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
        }
        .vibe-gradient { 
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); 
        }
        .flip-card { perspective: 1000px; }
        .flip-card-inner { transition: transform 0.6s; transform-style: preserve-3d; }
        .flipped .flip-card-inner { transform: rotateY(180deg); }
        .flip-front, .flip-back { backface-visibility: hidden; position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .flip-back { transform: rotateY(180deg); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;

        // Create a promise that resolves when GameComponents are ready
        const waitForGameComponents = () => {
            return new Promise((resolve) => {
                const checkComponents = () => {
                    if (window.GameComponents && 
                        window.GameComponents.MCQGame && 
                        window.GameComponents.TrueFalseGame &&
                        window.GameComponents.FlashcardGame &&
                        window.GameComponents.FillBlankGame &&
                        window.GameComponents.QAGame) {
                        console.log('‚úÖ All GameComponents ready!');
                        resolve();
                    } else {
                        console.log('‚è≥ Waiting for GameComponents...');
                        setTimeout(checkComponents, 100);
                    }
                };
                checkComponents();
            });
        };

        // Helper to get game components safely with better debugging
        const getGameComponent = (name) => {
            console.log(`üîç Looking for component: ${name}`);
            
            // First, check window.GameComponents
            if (window.GameComponents) {
                console.log(`‚úÖ window.GameComponents exists with keys:`, Object.keys(window.GameComponents));
                if (window.GameComponents[name]) {
                    console.log(`‚úÖ Found ${name} in window.GameComponents`);
                    return window.GameComponents[name];
                }
            }
            
            // Then check window directly
            if (window[name]) {
                console.log(`‚úÖ Found ${name} directly on window`);
                return window[name];
            }
            
            console.error(`‚ùå Component not found: ${name}`);
            console.log(`Debug - window.GameComponents:`, window.GameComponents);
            return null;
        };

        // AUTH SCREEN
        const AuthScreen = ({ onLogin }) => {
            const [isRegister, setIsRegister] = useState(false);
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async () => {
                if (!username || !password) {
                    setError('Vui l√≤ng nh·∫≠p t√™n ƒëƒÉng nh·∫≠p v√† m·∫≠t kh·∫©u');
                    return;
                }
                setError('');
                setLoading(true);
                const endpoint = isRegister ? '/api/register' : '/api/login';
                try {
                    const res = await fetch(endpoint, { 
                        method: 'POST', 
                        headers: {'Content-Type': 'application/json'}, 
                        body: JSON.stringify({ username, password }) 
                    });
                    const data = await res.json();
                    if (data.success) { 
                        if (data.user.role === 'admin') { 
                            setError("Admin vui l√≤ng v√†o /admin"); 
                            setLoading(false);
                            return; 
                        } 
                        localStorage.setItem('vibe_token', data.token);
                        localStorage.setItem('vibe_user', JSON.stringify(data.user));
                        onLogin(data.user, data.token); 
                    } else {
                        setError(data.message || 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i');
                    }
                } catch (e) { 
                    setError('L·ªói k·∫øt n·ªëi: ' + e.message); 
                } finally {
                    setLoading(false);
                }
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter') handleSubmit();
            };

            return (
                <div className="h-screen w-screen flex items-center justify-center bg-gradient-to-br from-slate-900 to-slate-950">
                    <div className="absolute inset-0 bg-black/30"></div>
                    <div className="relative glass-panel p-8 rounded-2xl w-96 shadow-2xl border-t border-purple-500/50 animate-fade-in">
                        <div className="text-center mb-8">
                            <h1 className="text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-cyan-400 to-purple-500">VIBE</h1>
                            <p className="text-gray-400 text-sm mt-2">Edutainment Ecosystem</p>
                        </div>
                        
                        <div className="flex bg-slate-800 rounded-lg p-1 mb-6">
                            <button 
                                onClick={() => {setIsRegister(false); setError('');}} 
                                className={`flex-1 py-2 rounded-md text-sm font-bold transition ${!isRegister ? 'bg-indigo-600 text-white' : 'text-slate-400 hover:text-white'}`}
                            >
                                ƒêƒÉng Nh·∫≠p
                            </button>
                            <button 
                                onClick={() => {setIsRegister(true); setError('');}} 
                                className={`flex-1 py-2 rounded-md text-sm font-bold transition ${isRegister ? 'bg-indigo-600 text-white' : 'text-slate-400 hover:text-white'}`}
                            >
                                ƒêƒÉng K√Ω
                            </button>
                        </div>

                        {error && <div className="bg-red-500/20 text-red-300 text-sm p-3 rounded mb-4 text-center border border-red-500/30">{error}</div>}
                        
                        <input 
                            className="w-full bg-slate-800/50 border border-slate-600 rounded-lg p-3 mb-4 text-white placeholder-slate-500 focus:outline-none focus:border-indigo-500" 
                            placeholder="T√™n ƒëƒÉng nh·∫≠p" 
                            value={username} 
                            onChange={e => setUsername(e.target.value)}
                            onKeyPress={handleKeyPress}
                            disabled={loading}
                        />
                        
                        <input 
                            className="w-full bg-slate-800/50 border border-slate-600 rounded-lg p-3 mb-6 text-white placeholder-slate-500 focus:outline-none focus:border-indigo-500" 
                            type="password" 
                            placeholder="M·∫≠t kh·∫©u" 
                            value={password} 
                            onChange={e => setPassword(e.target.value)}
                            onKeyPress={handleKeyPress}
                            disabled={loading}
                        />

                        {isRegister && <p className="text-xs text-slate-400 mb-4">M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 8 k√Ω t·ª±, ch·ª©a ch·ªØ hoa, ch·ªØ th∆∞·ªùng v√† s·ªë</p>}
                        
                        <button 
                            onClick={handleSubmit} 
                            disabled={loading}
                            className={`w-full p-3 rounded-lg font-bold shadow-lg transition ${loading ? 'bg-slate-700 text-slate-500 cursor-not-allowed' : 'vibe-gradient hover:opacity-90 active:scale-95'}`}
                        >
                            {loading ? 'ƒêang x·ª≠ l√Ω...' : (isRegister ? 'T·∫°o T√†i Kho·∫£n' : 'B·∫Øt ƒê·∫ßu H·ªçc')}
                        </button>

                        {!isRegister && <p className="text-xs text-slate-500 text-center mt-4">Demo: student / Student@123</p>}
                    </div>
                </div>
            );
        };

        // ACCOUNT MODAL
        const AccountModal = ({ user, onClose }) => (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 backdrop-blur-sm" onClick={onClose}>
                <div className="glass-panel bg-slate-900 p-8 rounded-2xl w-full max-w-md border border-slate-700 shadow-2xl relative" onClick={e => e.stopPropagation()}>
                    <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-white">
                        <i className="fa-solid fa-xmark text-xl"></i>
                    </button>
                    <div className="text-center mb-6">
                        <div className="w-20 h-20 rounded-full bg-slate-800 mx-auto mb-4 flex items-center justify-center border-2 border-indigo-500">
                            <i className="fa-solid fa-user text-3xl text-indigo-400"></i>
                        </div>
                        <h2 className="text-2xl font-bold">{user.username}</h2>
                        <p className="text-slate-400">{user.role === 'admin' ? 'Admin' : 'H·ªçc vi√™n'}</p>
                    </div>
                    <div className="p-4 bg-slate-800/50 rounded-xl border border-slate-700">
                        <div className="flex justify-between items-center">
                            <span className="text-slate-300">G√≥i hi·ªán t·∫°i</span>
                            {user.isPremium ? (
                                <span className="bg-yellow-500/20 text-yellow-400 px-3 py-1 rounded-full text-xs font-bold border border-yellow-500/30">PRO PLAN</span>
                            ) : (
                                <span className="bg-slate-700 text-slate-300 px-3 py-1 rounded-full text-xs font-bold">FREE PLAN</span>
                            )}
                        </div>
                    </div>
                </div>
            </div>
        );

        // PREMIUM MODAL
        const PremiumModal = ({ user, onClose, onUpgrade }) => {
            const [step, setStep] = useState(1);
            const [selectedPlan, setSelectedPlan] = useState(null);
            
            const handleSelect = (plan) => {
                setSelectedPlan(plan);
                setStep(2);
            };
            
            const qrImageSrc = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=VIBE_${selectedPlan}_${user.username}`;

            return (
                <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 backdrop-blur-sm" onClick={onClose}>
                    <div className="bg-slate-900 glass-panel rounded-3xl w-full max-w-2xl border border-yellow-500/30 shadow-2xl overflow-hidden relative" onClick={e => e.stopPropagation()}>
                        <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-white z-10">
                            <i className="fa-solid fa-xmark text-xl"></i>
                        </button>
                        
                        <div className="flex h-[500px]">
                            {/* Left Side - Feature List */}
                            <div className="w-1/3 bg-gradient-to-br from-yellow-600 to-orange-800 p-8 flex flex-col justify-between relative overflow-hidden">
                                <div className="relative z-10">
                                    <h2 className="text-3xl font-bold text-white mb-2">Vibe Pro</h2>
                                    <p className="text-yellow-100 text-sm">M·ªü kh√≥a s·ª©c m·∫°nh AI.</p>
                                </div>
                                <ul className="relative z-10 space-y-3 text-sm text-yellow-50 font-medium">
                                    <li><i className="fa-solid fa-check mr-2"></i> T·∫•t c·∫£ Game Modes</li>
                                    <li><i className="fa-solid fa-check mr-2"></i> T√πy ch·ªânh s·ªë c√¢u</li>
                                    <li><i className="fa-solid fa-check mr-2"></i> T·∫≠p trung ch·ªß ƒë·ªÅ</li>
                                    <li><i className="fa-solid fa-check mr-2"></i> H·ªó tr·ª£ ∆∞u ti√™n</li>
                                </ul>
                            </div>

                            {/* Right Side - Selection */}
                            <div className="w-2/3 p-8 bg-slate-900 flex flex-col justify-center">
                                {step === 1 ? (
                                    <>
                                        <h3 className="text-2xl font-bold mb-6 text-center">Ch·ªçn g√≥i</h3>
                                        <div className="grid grid-cols-2 gap-4 mb-6">
                                            <div 
                                                onClick={() => handleSelect('day')} 
                                                className="cursor-pointer border border-slate-700 hover:border-yellow-500 bg-slate-800 p-4 rounded-xl text-center group transition"
                                            >
                                                <div className="text-slate-400 text-sm mb-1">Ng√†y</div>
                                                <div className="text-2xl font-bold text-white group-hover:text-yellow-400">5.000 VND</div>
                                            </div>
                                            <div 
                                                onClick={() => handleSelect('month')} 
                                                className="cursor-pointer border-2 border-yellow-500 bg-slate-800 p-4 rounded-xl text-center group transition"
                                            >
                                                <div className="text-yellow-400 text-sm mb-1 font-bold">Ph·ªï bi·∫øn</div>
                                                <div className="text-2xl font-bold text-yellow-400">20.000 VND</div>
                                            </div>
                                        </div>
                                    </>
                                ) : (
                                    <div className="text-center animate-fade-in">
                                        <h3 className="text-xl font-bold mb-2">Qu√©t m√£ thanh to√°n</h3>
                                        <p className="text-yellow-400 font-bold text-lg mb-4">
                                            {selectedPlan === 'month' ? '20.000 VND' : '5.000 VND'}
                                        </p>
                                        <div className="bg-white p-2 rounded-xl w-48 h-48 mx-auto mb-4 flex items-center justify-center">
                                            <img src={qrImageSrc} alt="QR Code" className="max-w-full max-h-full" />
                                        </div>
                                        <p className="text-xs text-slate-400 mb-6">
                                            N·ªôi dung: <b>VIBE {user.username}</b>
                                        </p>
                                        <div className="flex gap-3">
                                            <button 
                                                onClick={() => setStep(1)} 
                                                className="flex-1 px-4 py-2 border border-slate-600 rounded-lg text-sm hover:bg-slate-800 transition"
                                            >
                                                Quay l·∫°i
                                            </button>
                                            <button 
                                                onClick={() => {
                                                    onUpgrade(selectedPlan);
                                                    onClose();
                                                }} 
                                                className="flex-1 px-4 py-2 bg-yellow-500 hover:bg-yellow-400 text-black font-bold rounded-lg text-sm transition"
                                            >
                                                X√°c nh·∫≠n thanh to√°n
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // DASHBOARD
        const Dashboard = ({ user, token, setUser, onLogout }) => {
            const [view, setView] = useState('dashboard');
            const [logs, setLogs] = useState([]);
            const [currentGame, setCurrentGame] = useState(null);
            const [loading, setLoading] = useState(false);
            const [showAccount, setShowAccount] = useState(false);
            const [showPremium, setShowPremium] = useState(false);

            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };

            useEffect(() => { fetchLogs(); }, [user, token]);

            const fetchLogs = async () => { 
                try {
                    const r = await fetch(`/api/logs/${user.id}`, { headers }); 
                    const d = await r.json(); 
                    if (d.success) setLogs(d.logs); 
                    else console.error('Error fetching logs:', d);
                } catch (e) {
                    console.error('Fetch error:', e);
                }
            };

            const handleCreate = async (file, mode, customNum, focusTopic) => {
                setLoading(true); 
                const fd = new FormData(); 
                fd.append('file', file); 
                fd.append('mode', mode); 
                fd.append('userId', user.id); 
                fd.append('isPremium', user.isPremium); 
                if (customNum) fd.append('customNum', customNum); 
                if (focusTopic) fd.append('focusTopic', focusTopic);
                
                try { 
                    const r = await fetch('/api/generate', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: fd
                    }); 
                    const d = await r.json(); 
                    if (d.success) { 
                        console.log('üìä Game data received from server:', d.data);
                        console.log('üìä Game mode:', mode);
                        setCurrentGame({ data: d.data, mode }); 
                        setView('play'); 
                        fetchLogs(); 
                    } else {
                        alert('L·ªói: ' + d.error); 
                    }
                } catch (e) {
                    alert('L·ªói: ' + e.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleRename = async (gameId, currentName, e) => {
                e.stopPropagation();
                const newName = prompt("Nh·∫≠p t√™n m·ªõi cho b√†i h·ªçc:", currentName);
                if (newName && newName !== currentName) {
                    try {
                        const res = await fetch('/api/game/rename', {
                            method: 'POST', 
                            headers,
                            body: JSON.stringify({ userId: user.id, gameId, newName })
                        });
                        if ((await res.json()).success) fetchLogs();
                    } catch (e) {
                        alert('L·ªói: ' + e.message);
                    }
                }
            };

            const handleDelete = async (gameId, e) => {
                e.stopPropagation();
                if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b√†i h·ªçc n√†y kh√¥ng?")) {
                    try {
                        const res = await fetch('/api/game/delete', {
                            method: 'POST', 
                            headers,
                            body: JSON.stringify({ userId: user.id, gameId })
                        });
                        if ((await res.json()).success) fetchLogs();
                    } catch (e) {
                        alert('L·ªói: ' + e.message);
                    }
                }
            };

            const handleUpgrade = async (plan) => {
                try {
                    const res = await fetch('/api/buy-premium', {
                        method: 'POST',
                        headers,
                        body: JSON.stringify({ userId: user.id, plan })
                    });
                    const data = await res.json();
                    if (data.success) {
                        setUser(data.user);
                        localStorage.setItem('vibe_user', JSON.stringify(data.user));
                        alert('‚úÖ N√¢ng c·∫•p th√†nh c√¥ng!');
                    } else {
                        alert('‚ùå ' + (data.message || 'N√¢ng c·∫•p th·∫•t b·∫°i'));
                    }
                } catch (e) {
                    alert('‚ùå L·ªói: ' + e.message);
                }
            };

            return (
                <div className="flex h-screen overflow-hidden bg-slate-950">
                    {/* SIDEBAR */}
                    <div className="w-64 bg-slate-900 border-r border-slate-800 p-6 flex flex-col z-10">
                        <div className="flex items-center gap-3 mb-10">
                            <div className="w-10 h-10 rounded-full vibe-gradient flex items-center justify-center font-bold text-lg">V</div>
                            <span className="font-bold text-xl tracking-wider">VIBE</span>
                        </div>
                        
                        <nav className="flex-1 space-y-2">
                            <button 
                                onClick={() => setView('dashboard')} 
                                className={`w-full flex items-center gap-3 p-3 rounded-xl transition-all ${view === 'dashboard' ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-400 hover:bg-slate-800'}`}
                            >
                                <i className="fa-solid fa-chart-pie"></i>
                                <span className="font-medium">Dashboard</span>
                            </button>
                            <button 
                                onClick={() => setView('create')} 
                                className={`w-full flex items-center gap-3 p-3 rounded-xl transition-all ${view === 'create' ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-400 hover:bg-slate-800'}`}
                            >
                                <i className="fa-solid fa-gamepad"></i>
                                <span className="font-medium">AI Game Studio</span>
                            </button>
                            {!user.isPremium && (
                                <button 
                                    onClick={() => setShowPremium(true)} 
                                    className="w-full flex items-center gap-3 p-3 rounded-xl transition-all text-yellow-400 hover:bg-yellow-500/10 border border-yellow-500/30"
                                >
                                    <i className="fa-solid fa-crown"></i>
                                    <span className="font-medium">N√¢ng c·∫•p Pro</span>
                                </button>
                            )}
                        </nav>

                        <div className="mt-auto pt-6 border-t border-slate-800">
                            {!user.isPremium && (
                                <button 
                                    onClick={() => setShowPremium(true)} 
                                    className="w-full mb-4 flex items-center justify-center gap-2 p-3 rounded-lg bg-yellow-500/20 text-yellow-400 hover:bg-yellow-500/30 border border-yellow-500/50 font-bold text-sm transition"
                                >
                                    <i className="fa-solid fa-crown"></i>
                                    N√¢ng c·∫•p Pro
                                </button>
                            )}
                            <div 
                                className="flex items-center gap-3 mb-3 cursor-pointer hover:bg-slate-800 p-2 rounded-lg transition" 
                                onClick={() => setShowAccount(true)}
                            >
                                <div className="w-8 h-8 rounded-full bg-indigo-500 flex items-center justify-center font-bold text-sm">
                                    {user.username[0].toUpperCase()}
                                </div>
                                <div className="overflow-hidden">
                                    <div className="font-bold text-sm truncate">{user.username}</div>
                                    <div className="text-xs text-slate-400">{user.isPremium ? 'Pro Plan' : 'Free Plan'}</div>
                                </div>
                            </div>
                            <button 
                                onClick={onLogout} 
                                className="text-red-400 hover:text-red-300 font-bold text-xs flex items-center gap-2 px-2"
                            >
                                <i className="fa-solid fa-right-from-bracket"></i> 
                                ƒêƒÉng xu·∫•t
                            </button>
                        </div>
                    </div>

                    {/* MAIN CONTENT */}
                    <div className="flex-1 bg-slate-950 relative overflow-y-auto">
                        {view === 'dashboard' && (
                            <div className="p-8 animate-fade-in">
                                <h2 className="text-3xl font-bold mb-6">Th∆∞ vi·ªán b√†i h·ªçc</h2>
                                {logs.length === 0 ? (
                                    <p className="text-slate-500 text-center py-12">Ch∆∞a c√≥ b√†i h·ªçc n√†o. T·∫°o b√†i h·ªçc ƒë·∫ßu ti√™n trong AI Game Studio!</p>
                                ) : (
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                        {logs.map(l => (
                                            <div 
                                                key={l.id} 
                                                onClick={() => {setCurrentGame({ data: l.data, mode: l.mode }); setView('play');}} 
                                                className="glass-panel p-5 rounded-2xl cursor-pointer hover:border-indigo-500 transition hover:-translate-y-1 relative group"
                                            >
                                                <div className="flex justify-between items-center mb-3">
                                                    <span className="text-xs font-bold bg-slate-700 text-slate-300 px-2 py-1 rounded uppercase tracking-wider">
                                                        {l.mode}
                                                    </span>
                                                    <div className="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                        <button 
                                                            onClick={(e) => handleRename(l.id, l.customTitle || l.fileName, e)} 
                                                            className="text-slate-400 hover:text-white p-1" 
                                                            title="ƒê·ªïi t√™n"
                                                        >
                                                            <i className="fa-solid fa-pen"></i>
                                                        </button>
                                                        <button 
                                                            onClick={(e) => handleDelete(l.id, e)} 
                                                            className="text-slate-400 hover:text-red-500 p-1" 
                                                            title="X√≥a"
                                                        >
                                                            <i className="fa-solid fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                <h3 className="font-bold text-lg truncate mb-1">{l.customTitle || l.fileName}</h3>
                                                <div className="flex justify-between text-xs text-slate-400">
                                                    <span>{l.data.length} c√¢u</span>
                                                    <span>{new Date(l.createdAt).toLocaleDateString('vi-VN')}</span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}

                        {view === 'create' && <CreateGameView onCreate={handleCreate} loading={loading} isPremium={user.isPremium} />}
                        
                        {view === 'play' && currentGame && (
                            <GamePlayer game={currentGame} onBack={() => setView('dashboard')} isPremium={user.isPremium} />
                        )}
                    </div>

                    {showAccount && <AccountModal user={user} onClose={() => setShowAccount(false)} />}
                    {showPremium && <PremiumModal user={user} onClose={() => setShowPremium(false)} onUpgrade={handleUpgrade} />}
                </div>
            );
        };

        // CREATE GAME VIEW
        const CreateGameView = ({ onCreate, loading, isPremium }) => {
            const [file, setFile] = useState(null);
            const [mode, setMode] = useState('multiple_choice');
            const [num, setNum] = useState(10);
            const [focus, setFocus] = useState('');

            const modes = [
                { id: 'multiple_choice', label: 'Tr·∫Øc nghi·ªám', icon: 'fa-list-ul', free: true },
                { id: 'flashcard', label: 'Flashcard', icon: 'fa-clone', free: true },
                { id: 'true_false', label: 'ƒê√∫ng / Sai', icon: 'fa-check-double', free: false },
                { id: 'fill_blank', label: 'ƒêi·ªÅn t·ª´', icon: 'fa-pen-to-square', free: false },
                { id: 'qa', label: 'H·ªèi ƒë√°p', icon: 'fa-comments', free: false }
            ];

            return (
                <div className="p-8 h-full flex items-center justify-center animate-fade-in">
                    {loading ? (
                        <div className="text-center">
                            <div className="w-16 h-16 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                            <p className="text-lg">AI ƒëang ƒë·ªçc t√†i li·ªáu...</p>
                        </div>
                    ) : (
                        <div className="glass-panel p-8 rounded-3xl w-full max-w-2xl border-t border-indigo-500/50 shadow-2xl">
                            <h2 className="text-3xl font-bold mb-6 text-center">AI Game Studio</h2>
                            
                            <div className="space-y-6">
                                <div>
                                    <label className="block text-sm font-bold text-slate-400 mb-2">1. Upload PDF</label>
                                    <div className="border-2 border-dashed border-slate-600 hover:border-indigo-500 bg-slate-900/50 rounded-xl p-8 text-center relative group cursor-pointer transition">
                                        <input 
                                            type="file" 
                                            accept=".pdf" 
                                            onChange={e => setFile(e.target.files[0])} 
                                            className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"
                                        />
                                        <i className="fa-solid fa-cloud-arrow-up text-4xl text-indigo-400 mb-2"></i>
                                        <p className="text-sm text-slate-200">{file ? file.name : "Ch·ªçn file PDF"}</p>
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-sm font-bold text-slate-400 mb-2">2. Ch·ªçn Mode</label>
                                    <div className="grid grid-cols-3 gap-2">
                                        {modes.map(mo => (
                                            <button
                                                key={mo.id}
                                                onClick={() => !(!mo.free && !isPremium) && setMode(mo.id)}
                                                disabled={!mo.free && !isPremium}
                                                className={`p-3 rounded-xl border text-xs font-bold flex flex-col items-center gap-2 relative transition ${
                                                    mode === mo.id
                                                        ? 'border-indigo-500 bg-indigo-500/20 text-white'
                                                        : 'border-slate-700 bg-slate-800/50 text-slate-400 hover:border-slate-600'
                                                } ${!mo.free && !isPremium ? 'opacity-50 cursor-not-allowed' : ''}`}
                                            >
                                                <i className={`fa-solid ${mo.icon} text-lg`}></i>
                                                {mo.label}
                                                {!mo.free && !isPremium && (
                                                    <div className="absolute inset-0 bg-black/60 flex items-center justify-center rounded-xl">
                                                        <i className="fa-solid fa-lock text-yellow-500"></i>
                                                    </div>
                                                )}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {isPremium && (
                                    <div className="p-4 bg-slate-800/50 rounded-xl border border-yellow-500/30">
                                        <div className="flex items-center gap-2 mb-3 text-yellow-400 font-bold text-sm">
                                            <i className="fa-solid fa-sliders"></i> T√πy ch·ªânh (Pro)
                                        </div>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div>
                                                <label className="text-xs text-slate-400 block mb-1">S·ªë c√¢u ({num})</label>
                                                <input 
                                                    type="range" 
                                                    min="5" 
                                                    max="20" 
                                                    value={num} 
                                                    onChange={e => setNum(e.target.value)} 
                                                    className="w-full accent-yellow-500"
                                                />
                                            </div>
                                            <div>
                                                <label className="text-xs text-slate-400 block mb-1">Tr·ªçng t√¢m</label>
                                                <input 
                                                    type="text" 
                                                    placeholder="VD: ƒê·ªãnh nghƒ©a..." 
                                                    value={focus} 
                                                    onChange={e => setFocus(e.target.value)} 
                                                    className="w-full bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-white outline-none focus:border-indigo-500"
                                                />
                                            </div>
                                        </div>
                                    </div>
                                )}

                                <button 
                                    onClick={() => file && onCreate(file, mode, num, focus)} 
                                    disabled={!file}
                                    className={`w-full py-4 rounded-xl font-bold text-lg shadow-lg transition ${
                                        file ? 'vibe-gradient hover:scale-[1.02] active:scale-95' : 'bg-slate-800 text-slate-500 cursor-not-allowed'
                                    }`}
                                >
                                    Kh·ªüi T·∫°o
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // GAME PLAYER
        const GamePlayer = ({ game, onBack, isPremium }) => {
            const { data, mode } = game;
            const [isReady, setIsReady] = useState(false);
            const [retryCount, setRetryCount] = useState(0);
            const [componentStatus, setComponentStatus] = useState({});
            
            useEffect(() => {
                // Check components every 100ms up to 5 seconds (50 attempts)
                if (retryCount > 50) {
                    console.error('‚ùå Components failed to load after 50 attempts');
                    return;
                }

                const timer = setTimeout(() => {
                    const MCQGame = window.GameComponents?.MCQGame || window.MCQGame;
                    const TrueFalseGame = window.GameComponents?.TrueFalseGame || window.TrueFalseGame;
                    const FlashcardGame = window.GameComponents?.FlashcardGame || window.FlashcardGame;
                    const FillBlankGame = window.GameComponents?.FillBlankGame || window.FillBlankGame;
                    const QAGame = window.GameComponents?.QAGame || window.QAGame;
                    
                    const status = {
                        MCQGame: !!MCQGame,
                        TrueFalseGame: !!TrueFalseGame,
                        FlashcardGame: !!FlashcardGame,
                        FillBlankGame: !!FillBlankGame,
                        QAGame: !!QAGame
                    };
                    
                    setComponentStatus(status);
                    
                    if (MCQGame && TrueFalseGame && FlashcardGame && FillBlankGame && QAGame) {
                        console.log('‚úÖ All components ready on attempt', retryCount);
                        setIsReady(true);
                    } else {
                        console.log(`‚è≥ Waiting for components... attempt ${retryCount + 1}/50`, status);
                        setRetryCount(prev => prev + 1);
                    }
                }, 100);
                
                return () => clearTimeout(timer);
            }, [retryCount]);
            
            if (!isReady) {
                return (
                    <div className="p-8 flex flex-col items-center justify-center h-full">
                        <div className="text-center max-w-md">
                            {retryCount < 50 ? (
                                <>
                                    <div className="w-16 h-16 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                                    <p className="text-lg text-slate-300">ƒêang kh·ªüi t·∫°o tr√≤ ch∆°i...</p>
                                    <p className="text-xs text-slate-500 mt-2">T·∫£i th√†nh ph·∫ßn ({retryCount}/50)</p>
                                    <div className="mt-4 text-xs text-slate-600 bg-slate-800 p-3 rounded font-mono">
                                        {Object.entries(componentStatus).map(([name, ready]) => (
                                            <div key={name} className={ready ? 'text-green-500' : 'text-red-500'}>
                                                {ready ? '‚úì' : '‚úó'} {name}
                                            </div>
                                        ))}
                                    </div>
                                </>
                            ) : (
                                <>
                                    <i className="fa-solid fa-exclamation-circle text-4xl text-red-500 mb-4"></i>
                                    <p className="font-bold text-lg text-red-400 mb-2">‚ö†Ô∏è Game Components kh√¥ng t·∫£i ƒë∆∞·ª£c</p>
                                    <p className="text-sm text-slate-400 mb-4">Vui l√≤ng ki·ªÉm tra console (F12) ƒë·ªÉ xem chi ti·∫øt.</p>
                                    <div className="mt-4 text-xs text-slate-600 bg-slate-800 p-3 rounded font-mono text-left max-h-40 overflow-auto">
                                        <p className="font-bold mb-2">Tr·∫°ng th√°i th√†nh ph·∫ßn:</p>
                                        {Object.entries(componentStatus).map(([name, ready]) => (
                                            <div key={name} className={ready ? 'text-green-500' : 'text-red-500'}>
                                                {ready ? '‚úì' : '‚úó'} {name}
                                            </div>
                                        ))}
                                        <p className="text-slate-500 mt-2">window.GameComponents: {window.GameComponents ? '‚úì' : '‚úó'}</p>
                                    </div>
                                    <button 
                                        onClick={() => window.location.reload()}
                                        className="mt-4 bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded-lg text-sm font-bold"
                                    >
                                        T·∫£i l·∫°i trang
                                    </button>
                                </>
                            )}
                        </div>
                    </div>
                );
            }

            // Get components now that we're ready
            const MCQGame = window.GameComponents?.MCQGame || window.MCQGame;
            const TrueFalseGame = window.GameComponents?.TrueFalseGame || window.TrueFalseGame;
            const FlashcardGame = window.GameComponents?.FlashcardGame || window.FlashcardGame;
            const FillBlankGame = window.GameComponents?.FillBlankGame || window.FillBlankGame;
            const QAGame = window.GameComponents?.QAGame || window.QAGame;

            return (
                <div className="p-8 flex flex-col items-center h-full overflow-y-auto animate-fade-in">
                    <div className="w-full max-w-3xl flex items-center mb-6">
                        <button 
                            onClick={onBack} 
                            className="text-slate-400 hover:text-white flex items-center gap-2 transition"
                        >
                            <i className="fa-solid fa-arrow-left"></i> Quay l·∫°i
                        </button>
                    </div>
                    
                    {mode === 'flashcard' && FlashcardGame && <FlashcardGame data={data} />}
                    {mode === 'multiple_choice' && MCQGame && <MCQGame data={data} isPremium={isPremium} />}
                    {mode === 'true_false' && TrueFalseGame && <TrueFalseGame data={data} isPremium={isPremium} />}
                    {mode === 'fill_blank' && FillBlankGame && <FillBlankGame data={data} />}
                    {mode === 'qa' && QAGame && <QAGame data={data} />}
                </div>
            );
        };

        // MAIN APP
        function App() {
            const [user, setUser] = useState(null);
            const [token, setToken] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const checkAuth = () => {
                    const savedUser = localStorage.getItem('vibe_user');
                    const savedToken = localStorage.getItem('vibe_token');
                    if (savedUser && savedToken) {
                        try {
                            setUser(JSON.parse(savedUser));
                            setToken(savedToken);
                        } catch (e) {
                            localStorage.removeItem('vibe_user');
                            localStorage.removeItem('vibe_token');
                        }
                    }
                    setLoading(false);
                };
                checkAuth();
            }, []);

            const handleLogin = (u, t) => {
                setUser(u);
                setToken(t);
            };

            const handleLogout = () => {
                setUser(null);
                setToken(null);
                localStorage.removeItem('vibe_user');
                localStorage.removeItem('vibe_token');
            };

            if (loading) {
                return (
                    <div className="h-screen w-screen flex items-center justify-center bg-slate-950">
                        <div className="text-center">
                            <div className="w-12 h-12 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                            <p>ƒêang t·∫£i...</p>
                        </div>
                    </div>
                );
            }

            if (!user || !token) {
                return <AuthScreen onLogin={handleLogin} />;
            }

            return <Dashboard user={user} token={token} setUser={setUser} onLogout={handleLogout} />;
        }

        // RENDER
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    
    <!-- Game Components embedded inline with Babel transpilation -->
    <script type="text/babel">
        // Wait for React to be available
        if (typeof React === 'undefined') {
            console.error('‚ùå CRITICAL: React not available when GameComponents loaded!');
            throw new Error('React is required for GameComponents');
        }

        console.log('üöÄ GameComponents loading... React version:', React.version);
        const { useState: useState2, useEffect: useEffect2, useMemo: useMemo2 } = React;

        const sanitizeData = (data) => {
            if (!data) return [];
            if (Array.isArray(data)) {
                // Convert options from object to array if needed
                return data.map(q => {
                    // Handle multiple choice: convert object options to array and map answer letter to index
                    if (q.options && typeof q.options === 'object' && !Array.isArray(q.options)) {
                        const optionsArray = Object.values(q.options);
                        let correctAnswer = q.answer || q.correct_answer;
                        if (typeof correctAnswer === 'string') {
                            const answerMap = {'A': 0, 'B': 1, 'C': 2, 'D': 3, 'a': 0, 'b': 1, 'c': 2, 'd': 3};
                            correctAnswer = answerMap[correctAnswer] ?? correctAnswer;
                        }
                        return {
                            ...q,
                            options: optionsArray,
                            correct_answer: correctAnswer
                        };
                    }
                    
                    // Handle fill_blank: ensure key fields exist
                    if (q.sentence_with_blank && !q.question) {
                        return {
                            ...q,
                            question: q.sentence_with_blank
                        };
                    }
                    
                    // Handle qa: ensure key_points is array
                    if (q.suggested_answer && !Array.isArray(q.key_points)) {
                        return {
                            ...q,
                            key_points: q.key_points ? [q.key_points] : []
                        };
                    }
                    
                    // Handle true_false: normalize is_correct field
                    if ((q.statement || q.is_correct !== undefined) && q.is_correct === undefined && q.correct_answer !== undefined) {
                        return {
                            ...q,
                            is_correct: q.correct_answer
                        };
                    }
                    
                    return q;
                });
            }
            if (typeof data === 'object') {
                const keys = Object.keys(data);
                for (const key of keys) { if (Array.isArray(data[key])) return sanitizeData(data[key]); }
            }
            return [];
        };

        // --- 1. TR·∫ÆC NGHI·ªÜM (MCQ) ---
        const MCQGame = ({ data, isPremium }) => {
            const safeData = sanitizeData(data);
            const [answers, setAnswers] = useState2({});

            console.log('MCQGame received data:', data);
            console.log('MCQGame sanitized data:', safeData);
            console.log('MCQGame data length:', safeData.length);

            const shuffledData = useMemo2(() => {
                return safeData.map(q => {
                    if (!q.options) return q;
                    let correctContent = null;
                    if (typeof q.correct_answer === 'number' && q.options[q.correct_answer] !== undefined) {
                        correctContent = q.options[q.correct_answer];
                    } else if (typeof q.correct_answer === 'string' && q.correct_answer.trim()) {
                        const c = q.correct_answer.trim();
                        const map = {'a':0,'b':1,'c':2,'d':3,'A':0,'B':1,'C':2,'D':3};
                        if (map[c] !== undefined && q.options[map[c]] !== undefined) {
                            correctContent = q.options[map[c]];
                        } else {
                            const foundExact = q.options.find(o => o && o.trim().toLowerCase() === c.toLowerCase());
                            if (foundExact) correctContent = foundExact;
                            else {
                                const found = q.options.find(o => o && (o.toLowerCase().includes(c.toLowerCase()) || c.toLowerCase().includes(o.toLowerCase())));
                                if (found) correctContent = found;
                            }
                        }
                    }
                    const opts = [...q.options];
                    for (let i = opts.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [opts[i], opts[j]] = [opts[j], opts[i]];
                    }
                    const newIndex = correctContent ? opts.indexOf(correctContent) : -1;
                    const finalIndex = newIndex !== -1 ? newIndex : Math.floor(Math.random() * opts.length);
                    return { ...q, options: opts, correct_answer: finalIndex };
                });
            }, [safeData]);

            const handleSelect = (i, j) => { if (answers[i] === undefined) setAnswers(p => ({ ...p, [i]: j })); };

            if (safeData.length === 0) return (
                <div className="text-red-400 p-4 text-center max-w-md mx-auto mt-10">
                    <p className="font-bold mb-2">‚ùå Kh√¥ng c√≥ d·ªØ li·ªáu c√¢u h·ªèi</p>
                    <p className="text-sm">D·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c: {JSON.stringify(data).substring(0, 200)}</p>
                </div>
            );

            return (
                <div className="space-y-6 pb-20 w-full max-w-3xl">
                    {shuffledData.map((q, i) => {
                        const ua = answers[i];
                        const isA = ua !== undefined;
                        return (
                            <div key={i} className="glass-panel p-6 rounded-2xl border border-slate-700/50">
                                <h3 className="text-lg font-bold mb-4 text-white"><span className="text-indigo-400 mr-2">C√¢u {i+1}:</span>{q.question}</h3>
                                <div className="grid gap-3">
                                    {q.options && q.options.map((opt, j) => {
                                        let cls = "w-full p-4 text-left rounded-xl border transition-all flex items-center justify-between ";
                                        let icon = null;
                                        if(!isA) cls += "border-slate-700 bg-slate-800/40 hover:bg-slate-700 hover:border-indigo-500 text-slate-300";
                                        else {
                                            if(j===q.correct_answer) { cls += "border-green-500 bg-green-500/10 text-green-400 font-bold"; icon=<i className="fa-solid fa-check"></i>; }
                                            else if(j===ua) { cls += "border-red-500 bg-red-500/10 text-red-400"; icon=<i className="fa-solid fa-xmark"></i>; }
                                            else cls += "border-slate-800 bg-slate-900/20 text-slate-600 opacity-40";
                                        }
                                        return <button key={j} disabled={isA} onClick={()=>handleSelect(i,j)} className={cls}><span>{opt}</span>{icon}</button>
                                    })}
                                </div>
                                {isA && <div className={`mt-4 p-3 rounded-lg text-sm border ${ua===q.correct_answer?'bg-green-900/20 border-green-500/30':'bg-indigo-900/20 border-indigo-500/30'}`}><strong className={ua===q.correct_answer?'text-green-400':'text-yellow-400'}>{ua===q.correct_answer?'Ch√≠nh x√°c!':'Gi·∫£i th√≠ch:'}</strong> <span className="text-slate-300">{isPremium?q.explanation:"(N√¢ng c·∫•p Pro ƒë·ªÉ xem)"}</span></div>}
                            </div>
                        );
                    })}
                </div>
            );
        };

        // --- 2. ƒê√öNG / SAI (True/False) ---
        const TrueFalseGame = ({ data, isPremium }) => {
            const safeData = sanitizeData(data);
            const [answers, setAnswers] = useState2({});

            const handleSelect = (i, val) => { if (answers[i] === undefined) setAnswers(p => ({ ...p, [i]: val })); };
            const normalizeBool = (v) => {
                if (v === null || v === undefined) return false;
                if (typeof v === 'boolean') return v;
                if (typeof v === 'string') {
                    const str = v.trim().toLowerCase();
                    return str === 'true' || str === '1' || str === 'yes';
                }
                if (typeof v === 'number') return v === 1;
                return !!v;
            };

            if (safeData.length === 0) return <div className="text-red-400">L·ªói d·ªØ li·ªáu.</div>;

            return (
                <div className="grid gap-6 w-full max-w-2xl pb-20">
                    {safeData.map((item, i) => {
                        const ua = answers[i];
                        const isA = ua !== undefined;
                        let correctValue = item.is_correct;
                        if (correctValue === undefined) correctValue = item.correct_answer;
                        if (correctValue === undefined) correctValue = item.answer;
                        
                        const correct = normalizeBool(correctValue);
                        const isCorrect = ua === correct;

                        return (
                            <div key={i} className="glass-panel p-6 rounded-2xl border border-slate-700/50">
                                <h3 className="text-lg font-bold mb-6 text-white"><span className="text-indigo-400 mr-2">C√¢u {i+1}:</span>{item.statement || item.question || 'C√¢u h·ªèi kh√¥ng r√µ'}</h3>
                                <div className="grid grid-cols-2 gap-3">
                                    <button disabled={isA} onClick={() => handleSelect(i, true)} className={`p-4 rounded-xl border transition-all font-bold text-center flex items-center justify-center gap-2 ${!isA ? 'border-slate-700 bg-slate-800/40 hover:bg-slate-700 hover:border-green-500 text-slate-300' : (correct === true ? 'border-green-500 bg-green-500/10 text-green-400' : (ua === true ? 'border-red-500 bg-red-500/10 text-red-400' : 'border-slate-800 bg-slate-900/20 text-slate-600 opacity-40'))}`}><i className="fa-solid fa-check"></i> ƒê√öNG</button>
                                    <button disabled={isA} onClick={() => handleSelect(i, false)} className={`p-4 rounded-xl border transition-all font-bold text-center flex items-center justify-center gap-2 ${!isA ? 'border-slate-700 bg-slate-800/40 hover:bg-slate-700 hover:border-red-500 text-slate-300' : (correct === false ? 'border-green-500 bg-green-500/10 text-green-400' : (ua === false ? 'border-red-500 bg-red-500/10 text-red-400' : 'border-slate-800 bg-slate-900/20 text-slate-600 opacity-40'))}`}><i className="fa-solid fa-xmark"></i> SAI</button>
                                </div>
                                {isA && <div className={`mt-4 p-3 rounded-lg text-sm border ${isCorrect ? 'bg-green-900/20 border-green-500/30' : 'bg-indigo-900/20 border-indigo-500/30'}`}><strong className={isCorrect ? 'text-green-400' : 'text-yellow-400'}>{isCorrect ? 'Ch√≠nh x√°c!' : 'Gi·∫£i th√≠ch:'}</strong> <span className="text-slate-300">{isPremium ? item.explanation : "(N√¢ng c·∫•p Pro ƒë·ªÉ xem)"}</span></div>}
                            </div>
                        );
                    })}
                </div>
            );
        };

        // --- 3. FLASHCARD ---
        const FlashcardGame = ({ data }) => { 
            const safeData = sanitizeData(data);
            const [i, setI] = useState2(0); 
            const [flip, setFlip] = useState2(false); 
            if (safeData.length === 0) return <div className="text-red-400">L·ªói d·ªØ li·ªáu th·∫ª.</div>;
            const next = () => { setFlip(false); setTimeout(() => setI((p) => (p + 1) % safeData.length), 300); };
            const prev = () => { setFlip(false); setTimeout(() => setI((p) => (p - 1 + safeData.length) % safeData.length), 300); };

            return (
                <div className="w-full max-w-md mx-auto perspective-1000 pb-20">
                    <div className="text-center mb-4 text-slate-400 text-sm font-bold tracking-widest">TH·∫∫ {i + 1} / {safeData.length}</div>
                    <div className={`flip-card w-full h-80 cursor-pointer group ${flip ? 'flipped' : ''}`} onClick={() => setFlip(!flip)}>
                        <div className="flip-card-inner relative w-full h-full shadow-2xl rounded-3xl transition-transform duration-500">
                            <div className="flip-front absolute w-full h-full bg-slate-800 rounded-3xl flex flex-col items-center justify-center p-8 border border-slate-600 group-hover:border-indigo-500" style={{backfaceVisibility:'hidden'}}><span className="text-xs font-bold text-indigo-400 uppercase mb-4 tracking-widest">Thu·∫≠t ng·ªØ</span><h3 className="text-2xl font-bold text-center text-white">{safeData[i].front}</h3><p className="mt-8 text-slate-500 text-xs animate-bounce">Ch·∫°m ƒë·ªÉ l·∫≠t</p></div>
                            <div className="flip-back absolute w-full h-full vibe-gradient rounded-3xl flex flex-col items-center justify-center p-8 text-white" style={{backfaceVisibility:'hidden', transform:'rotateY(180deg)'}}><span className="text-xs font-bold text-white/70 uppercase mb-4 tracking-widest">ƒê·ªãnh nghƒ©a</span><p className="text-lg text-center font-medium">{safeData[i].back}</p></div>
                        </div>
                    </div>
                    <div className="flex justify-center gap-4 mt-8">
                        <button onClick={prev} className="p-4 bg-slate-800 rounded-full hover:bg-indigo-600 transition"><i className="fa-solid fa-arrow-left text-white"></i></button>
                        <button onClick={next} className="p-4 bg-slate-800 rounded-full hover:bg-indigo-600 transition"><i className="fa-solid fa-arrow-right text-white"></i></button>
                    </div>
                </div>
            ); 
        };

        // --- 4. ƒêI·ªÄN T·ª™ ---
        const FillBlankGame = ({ data }) => {
            const safeData = sanitizeData(data);
            if (safeData.length === 0) return <div className="text-red-400">L·ªói d·ªØ li·ªáu.</div>;

            return (
                <div className="space-y-6 w-full max-w-2xl pb-20">
                    {safeData.map((q, i) => {
                        const [val, setVal] = useState2('');
                        const [status, setStatus] = useState2('pending');
                        const parts = q.sentence_with_blank && q.sentence_with_blank.includes('[BLANK]') ? q.sentence_with_blank.split('[BLANK]') : [q.question || "C√¢u h·ªèi l·ªói", ""];
                        const check = () => { if (!q.hidden_word) { setStatus('wrong'); return; } if (val.trim().toLowerCase() === q.hidden_word.toLowerCase().trim()) setStatus('correct'); else setStatus('wrong'); };
                        return (
                            <div key={i} className="glass-panel p-8 rounded-2xl border border-slate-700/50">
                                <div className="text-xl leading-loose text-slate-200 mb-6">{parts[0]}<input type="text" disabled={status === 'correct'} value={val} onChange={e => setVal(e.target.value)} onKeyDown={e => e.key === 'Enter' && check()} className={`mx-2 bg-transparent border-b-2 outline-none text-center font-bold min-w-[120px] px-2 py-1 transition-colors ${status === 'correct' ? 'border-green-500 text-green-400' : (status === 'wrong' ? 'border-red-500 text-red-400' : 'border-indigo-500 text-white focus:border-white')}`} placeholder="..." />{parts[1] || ''}</div>
                                <div className="flex justify-between items-center"><div className="h-6">{status === 'wrong' && <span className="text-red-400 text-sm font-bold flex items-center animate-pulse"><i className="fa-solid fa-triangle-exclamation mr-2"></i>ƒê√°p √°n: {q.hidden_word}</span>}{status === 'correct' && <span className="text-green-400 text-sm font-bold flex items-center"><i className="fa-solid fa-check-circle mr-2"></i>Ch√≠nh x√°c!</span>}</div><button onClick={check} disabled={status === 'correct' || !val} className={`px-6 py-2 rounded-lg font-bold text-sm transition shadow-lg ${status === 'correct' ? 'bg-slate-700 text-slate-500 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-500 text-white hover:scale-105 active:scale-95'}`}>Ki·ªÉm tra</button></div>
                            </div>
                        );
                    })}
                </div>
            );
        };

        // --- 5. H·ªéI ƒê√ÅP ---
        const QAGame = ({ data }) => {
            const safeData = sanitizeData(data);
            if (safeData.length === 0) return <div className="text-red-400">L·ªói d·ªØ li·ªáu.</div>;

            return (
                <div className="space-y-6 w-full max-w-2xl pb-20">
                    {safeData.map((q, i) => {
                        const [revealed, setRevealed] = useState2(false);
                        return (
                            <div key={i} className="glass-panel p-0 rounded-2xl border border-slate-700/50 overflow-hidden">
                                <div className="p-6 bg-slate-800/50"><h3 className="font-bold text-indigo-400 text-xs uppercase tracking-widest mb-3">C√¢u h·ªèi t·ª± lu·∫≠n {i + 1}</h3><p className="text-xl font-bold text-white leading-relaxed">{q.question}</p></div>
                                <div className="p-6">{!revealed ? (<button onClick={() => setRevealed(true)} className="w-full py-10 border-2 border-dashed border-slate-700 rounded-xl text-slate-400 hover:border-indigo-500 hover:text-indigo-400 hover:bg-slate-800/50 transition-all flex flex-col items-center justify-center gap-3 group"><i className="fa-solid fa-eye text-2xl group-hover:scale-110 transition-transform"></i><span className="font-bold">Nh·∫•n ƒë·ªÉ xem ƒë√°p √°n g·ª£i √Ω</span></button>) : (<div className="animate-fade-in"><div className="bg-indigo-900/20 border-l-4 border-indigo-500 p-4 rounded-r-lg mb-4"><h4 className="text-indigo-300 font-bold text-sm mb-2">G·ª£i √Ω tr·∫£ l·ªùi:</h4><p className="text-white italic">"{q.suggested_answer}"</p></div><div className="space-y-2"><h4 className="text-slate-400 font-bold text-xs uppercase">C√°c √Ω ch√≠nh c·∫ßn c√≥:</h4>{q.key_points && q.key_points.map((k, j) => (<div key={j} className="flex items-start gap-3 p-2 rounded hover:bg-slate-800/50"><i className="fa-solid fa-check text-green-500 mt-1"></i><span className="text-slate-300 text-sm">{k}</span></div>))}</div><div className="mt-6 flex justify-end"><button onClick={() => setRevealed(false)} className="text-xs text-slate-500 hover:text-white underline">·∫®n ƒë√°p √°n</button></div></div>)}</div>
                            </div>
                        );
                    })}
                </div>
            );
        };

        // Export components
        window.GameComponents = { MCQGame, TrueFalseGame, FlashcardGame, FillBlankGame, QAGame };
        console.log('‚úÖ GameComponents loaded and exported:', Object.keys(window.GameComponents));
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vibe Edutainment</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Space Grotesk', sans-serif; 
            background-color: #0f172a; 
            color: white;
            width: 100%;
            height: 100vh;
            overflow: hidden;
        }
        #root { width: 100%; height: 100vh; }
        .glass-panel { 
            background: rgba(255, 255, 255, 0.05); 
            backdrop-filter: blur(10px); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
        }
        .vibe-gradient { 
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); 
        }
        .flip-card { perspective: 1000px; }
        .flip-card-inner { transition: transform 0.6s; transform-style: preserve-3d; }
        .flipped .flip-card-inner { transform: rotateY(180deg); }
        .flip-front, .flip-back { backface-visibility: hidden; position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .flip-back { transform: rotateY(180deg); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script id="game-components" src="GameComponents.js"></script>
    
    <script type="text/babel">
        const { useState, useEffect } = React;

        // Wait for GameComponents to load
        window.GameComponentsLoaded = false;
        if (document.getElementById('game-components')) {
            document.getElementById('game-components').onload = () => {
                window.GameComponentsLoaded = true;
                console.log('✅ GameComponents loaded');
            };
            document.getElementById('game-components').onerror = (e) => {
                console.error('❌ Error loading GameComponents:', e);
            };
        }

        // AUTH SCREEN
        const AuthScreen = ({ onLogin }) => {
            const [isRegister, setIsRegister] = useState(false);
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async () => {
                if (!username || !password) {
                    setError('Vui lòng nhập tên đăng nhập và mật khẩu');
                    return;
                }
                setError('');
                setLoading(true);
                const endpoint = isRegister ? '/api/register' : '/api/login';
                try {
                    const res = await fetch(endpoint, { 
                        method: 'POST', 
                        headers: {'Content-Type': 'application/json'}, 
                        body: JSON.stringify({ username, password }) 
                    });
                    const data = await res.json();
                    if (data.success) { 
                        if (data.user.role === 'admin') { 
                            setError("Admin vui lòng vào /admin"); 
                            setLoading(false);
                            return; 
                        } 
                        localStorage.setItem('vibe_token', data.token);
                        localStorage.setItem('vibe_user', JSON.stringify(data.user));
                        onLogin(data.user, data.token); 
                    } else {
                        setError(data.message || 'Đăng nhập thất bại');
                    }
                } catch (e) { 
                    setError('Lỗi kết nối: ' + e.message); 
                } finally {
                    setLoading(false);
                }
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter') handleSubmit();
            };

            return (
                <div className="h-screen w-screen flex items-center justify-center bg-gradient-to-br from-slate-900 to-slate-950">
                    <div className="absolute inset-0 bg-black/30"></div>
                    <div className="relative glass-panel p-8 rounded-2xl w-96 shadow-2xl border-t border-purple-500/50 animate-fade-in">
                        <div className="text-center mb-8">
                            <h1 className="text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-cyan-400 to-purple-500">VIBE</h1>
                            <p className="text-gray-400 text-sm mt-2">Edutainment Ecosystem</p>
                        </div>
                        
                        <div className="flex bg-slate-800 rounded-lg p-1 mb-6">
                            <button 
                                onClick={() => {setIsRegister(false); setError('');}} 
                                className={`flex-1 py-2 rounded-md text-sm font-bold transition ${!isRegister ? 'bg-indigo-600 text-white' : 'text-slate-400 hover:text-white'}`}
                            >
                                Đăng Nhập
                            </button>
                            <button 
                                onClick={() => {setIsRegister(true); setError('');}} 
                                className={`flex-1 py-2 rounded-md text-sm font-bold transition ${isRegister ? 'bg-indigo-600 text-white' : 'text-slate-400 hover:text-white'}`}
                            >
                                Đăng Ký
                            </button>
                        </div>

                        {error && <div className="bg-red-500/20 text-red-300 text-sm p-3 rounded mb-4 text-center border border-red-500/30">{error}</div>}
                        
                        <input 
                            className="w-full bg-slate-800/50 border border-slate-600 rounded-lg p-3 mb-4 text-white placeholder-slate-500 focus:outline-none focus:border-indigo-500" 
                            placeholder="Tên đăng nhập" 
                            value={username} 
                            onChange={e => setUsername(e.target.value)}
                            onKeyPress={handleKeyPress}
                            disabled={loading}
                        />
                        
                        <input 
                            className="w-full bg-slate-800/50 border border-slate-600 rounded-lg p-3 mb-6 text-white placeholder-slate-500 focus:outline-none focus:border-indigo-500" 
                            type="password" 
                            placeholder="Mật khẩu" 
                            value={password} 
                            onChange={e => setPassword(e.target.value)}
                            onKeyPress={handleKeyPress}
                            disabled={loading}
                        />

                        {isRegister && <p className="text-xs text-slate-400 mb-4">Mật khẩu phải có ít nhất 8 ký tự, chứa chữ hoa, chữ thường và số</p>}
                        
                        <button 
                            onClick={handleSubmit} 
                            disabled={loading}
                            className={`w-full p-3 rounded-lg font-bold shadow-lg transition ${loading ? 'bg-slate-700 text-slate-500 cursor-not-allowed' : 'vibe-gradient hover:opacity-90 active:scale-95'}`}
                        >
                            {loading ? 'Đang xử lý...' : (isRegister ? 'Tạo Tài Khoản' : 'Bắt Đầu Học')}
                        </button>

                        {!isRegister && <p className="text-xs text-slate-500 text-center mt-4">Demo: student / Student@123</p>}
                    </div>
                </div>
            );
        };

        // ACCOUNT MODAL
        const AccountModal = ({ user, onClose }) => (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 backdrop-blur-sm" onClick={onClose}>
                <div className="glass-panel bg-slate-900 p-8 rounded-2xl w-full max-w-md border border-slate-700 shadow-2xl relative" onClick={e => e.stopPropagation()}>
                    <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-white">
                        <i className="fa-solid fa-xmark text-xl"></i>
                    </button>
                    <div className="text-center mb-6">
                        <div className="w-20 h-20 rounded-full bg-slate-800 mx-auto mb-4 flex items-center justify-center border-2 border-indigo-500">
                            <i className="fa-solid fa-user text-3xl text-indigo-400"></i>
                        </div>
                        <h2 className="text-2xl font-bold">{user.username}</h2>
                        <p className="text-slate-400">{user.role === 'admin' ? 'Admin' : 'Học viên'}</p>
                    </div>
                    <div className="p-4 bg-slate-800/50 rounded-xl border border-slate-700">
                        <div className="flex justify-between items-center">
                            <span className="text-slate-300">Gói hiện tại</span>
                            {user.isPremium ? (
                                <span className="bg-yellow-500/20 text-yellow-400 px-3 py-1 rounded-full text-xs font-bold border border-yellow-500/30">PRO PLAN</span>
                            ) : (
                                <span className="bg-slate-700 text-slate-300 px-3 py-1 rounded-full text-xs font-bold">FREE PLAN</span>
                            )}
                        </div>
                    </div>
                </div>
            </div>
        );

        // PREMIUM MODAL
        const PremiumModal = ({ user, onClose, onUpgrade }) => {
            const [step, setStep] = useState(1);
            const [selectedPlan, setSelectedPlan] = useState(null);
            
            const handleSelect = (plan) => {
                setSelectedPlan(plan);
                setStep(2);
            };
            
            const qrImageSrc = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=VIBE_${selectedPlan}_${user.username}`;

            return (
                <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 backdrop-blur-sm" onClick={onClose}>
                    <div className="bg-slate-900 glass-panel rounded-3xl w-full max-w-2xl border border-yellow-500/30 shadow-2xl overflow-hidden relative" onClick={e => e.stopPropagation()}>
                        <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-white z-10">
                            <i className="fa-solid fa-xmark text-xl"></i>
                        </button>
                        
                        <div className="flex h-[500px]">
                            {/* Left Side - Feature List */}
                            <div className="w-1/3 bg-gradient-to-br from-yellow-600 to-orange-800 p-8 flex flex-col justify-between relative overflow-hidden">
                                <div className="relative z-10">
                                    <h2 className="text-3xl font-bold text-white mb-2">Vibe Pro</h2>
                                    <p className="text-yellow-100 text-sm">Mở khóa sức mạnh AI.</p>
                                </div>
                                <ul className="relative z-10 space-y-3 text-sm text-yellow-50 font-medium">
                                    <li><i className="fa-solid fa-check mr-2"></i> Tất cả Game Modes</li>
                                    <li><i className="fa-solid fa-check mr-2"></i> Tùy chỉnh số câu</li>
                                    <li><i className="fa-solid fa-check mr-2"></i> Tập trung chủ đề</li>
                                    <li><i className="fa-solid fa-check mr-2"></i> Hỗ trợ ưu tiên</li>
                                </ul>
                            </div>

                            {/* Right Side - Selection */}
                            <div className="w-2/3 p-8 bg-slate-900 flex flex-col justify-center">
                                {step === 1 ? (
                                    <>
                                        <h3 className="text-2xl font-bold mb-6 text-center">Chọn gói</h3>
                                        <div className="grid grid-cols-2 gap-4 mb-6">
                                            <div 
                                                onClick={() => handleSelect('day')} 
                                                className="cursor-pointer border border-slate-700 hover:border-yellow-500 bg-slate-800 p-4 rounded-xl text-center group transition"
                                            >
                                                <div className="text-slate-400 text-sm mb-1">Ngày</div>
                                                <div className="text-2xl font-bold text-white group-hover:text-yellow-400">5.000 VND</div>
                                            </div>
                                            <div 
                                                onClick={() => handleSelect('month')} 
                                                className="cursor-pointer border-2 border-yellow-500 bg-slate-800 p-4 rounded-xl text-center group transition"
                                            >
                                                <div className="text-yellow-400 text-sm mb-1 font-bold">Phổ biến</div>
                                                <div className="text-2xl font-bold text-yellow-400">20.000 VND</div>
                                            </div>
                                        </div>
                                    </>
                                ) : (
                                    <div className="text-center animate-fade-in">
                                        <h3 className="text-xl font-bold mb-2">Quét mã thanh toán</h3>
                                        <p className="text-yellow-400 font-bold text-lg mb-4">
                                            {selectedPlan === 'month' ? '20.000 VND' : '5.000 VND'}
                                        </p>
                                        <div className="bg-white p-2 rounded-xl w-48 h-48 mx-auto mb-4 flex items-center justify-center">
                                            <img src={qrImageSrc} alt="QR Code" className="max-w-full max-h-full" />
                                        </div>
                                        <p className="text-xs text-slate-400 mb-6">
                                            Nội dung: <b>VIBE {user.username}</b>
                                        </p>
                                        <div className="flex gap-3">
                                            <button 
                                                onClick={() => setStep(1)} 
                                                className="flex-1 px-4 py-2 border border-slate-600 rounded-lg text-sm hover:bg-slate-800 transition"
                                            >
                                                Quay lại
                                            </button>
                                            <button 
                                                onClick={() => {
                                                    onUpgrade(selectedPlan);
                                                    onClose();
                                                }} 
                                                className="flex-1 px-4 py-2 bg-yellow-500 hover:bg-yellow-400 text-black font-bold rounded-lg text-sm transition"
                                            >
                                                Xác nhận thanh toán
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // DASHBOARD
        const Dashboard = ({ user, token, setUser, onLogout }) => {
            const [view, setView] = useState('dashboard');
            const [logs, setLogs] = useState([]);
            const [currentGame, setCurrentGame] = useState(null);
            const [loading, setLoading] = useState(false);
            const [showAccount, setShowAccount] = useState(false);
            const [showPremium, setShowPremium] = useState(false);

            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };

            useEffect(() => { fetchLogs(); }, [user, token]);

            const fetchLogs = async () => { 
                try {
                    const r = await fetch(`/api/logs/${user.id}`, { headers }); 
                    const d = await r.json(); 
                    if (d.success) setLogs(d.logs); 
                    else console.error('Error fetching logs:', d);
                } catch (e) {
                    console.error('Fetch error:', e);
                }
            };

            const handleCreate = async (file, mode, customNum, focusTopic) => {
                setLoading(true); 
                const fd = new FormData(); 
                fd.append('file', file); 
                fd.append('mode', mode); 
                fd.append('userId', user.id); 
                fd.append('isPremium', user.isPremium); 
                if (customNum) fd.append('customNum', customNum); 
                if (focusTopic) fd.append('focusTopic', focusTopic);
                
                try { 
                    const r = await fetch('/api/generate', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: fd
                    }); 
                    const d = await r.json(); 
                    if (d.success) { 
                        setCurrentGame({ data: d.data, mode }); 
                        setView('play'); 
                        fetchLogs(); 
                    } else {
                        alert('Lỗi: ' + d.error); 
                    }
                } catch (e) {
                    alert('Lỗi: ' + e.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleRename = async (gameId, currentName, e) => {
                e.stopPropagation();
                const newName = prompt("Nhập tên mới cho bài học:", currentName);
                if (newName && newName !== currentName) {
                    try {
                        const res = await fetch('/api/game/rename', {
                            method: 'POST', 
                            headers,
                            body: JSON.stringify({ userId: user.id, gameId, newName })
                        });
                        if ((await res.json()).success) fetchLogs();
                    } catch (e) {
                        alert('Lỗi: ' + e.message);
                    }
                }
            };

            const handleDelete = async (gameId, e) => {
                e.stopPropagation();
                if (confirm("Bạn có chắc muốn xóa bài học này không?")) {
                    try {
                        const res = await fetch('/api/game/delete', {
                            method: 'POST', 
                            headers,
                            body: JSON.stringify({ userId: user.id, gameId })
                        });
                        if ((await res.json()).success) fetchLogs();
                    } catch (e) {
                        alert('Lỗi: ' + e.message);
                    }
                }
            };

            const handleUpgrade = async (plan) => {
                try {
                    const res = await fetch('/api/buy-premium', {
                        method: 'POST',
                        headers,
                        body: JSON.stringify({ userId: user.id, plan })
                    });
                    const data = await res.json();
                    if (data.success) {
                        setUser(data.user);
                        localStorage.setItem('vibe_user', JSON.stringify(data.user));
                        alert('✅ Nâng cấp thành công!');
                    } else {
                        alert('❌ ' + (data.message || 'Nâng cấp thất bại'));
                    }
                } catch (e) {
                    alert('❌ Lỗi: ' + e.message);
                }
            };

            return (
                <div className="flex h-screen overflow-hidden bg-slate-950">
                    {/* SIDEBAR */}
                    <div className="w-64 bg-slate-900 border-r border-slate-800 p-6 flex flex-col z-10">
                        <div className="flex items-center gap-3 mb-10">
                            <div className="w-10 h-10 rounded-full vibe-gradient flex items-center justify-center font-bold text-lg">V</div>
                            <span className="font-bold text-xl tracking-wider">VIBE</span>
                        </div>
                        
                        <nav className="flex-1 space-y-2">
                            <button 
                                onClick={() => setView('dashboard')} 
                                className={`w-full flex items-center gap-3 p-3 rounded-xl transition-all ${view === 'dashboard' ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-400 hover:bg-slate-800'}`}
                            >
                                <i className="fa-solid fa-chart-pie"></i>
                                <span className="font-medium">Dashboard</span>
                            </button>
                            <button 
                                onClick={() => setView('create')} 
                                className={`w-full flex items-center gap-3 p-3 rounded-xl transition-all ${view === 'create' ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-400 hover:bg-slate-800'}`}
                            >
                                <i className="fa-solid fa-gamepad"></i>
                                <span className="font-medium">AI Game Studio</span>
                            </button>
                            {!user.isPremium && (
                                <button 
                                    onClick={() => setShowPremium(true)} 
                                    className="w-full flex items-center gap-3 p-3 rounded-xl transition-all text-yellow-400 hover:bg-yellow-500/10 border border-yellow-500/30"
                                >
                                    <i className="fa-solid fa-crown"></i>
                                    <span className="font-medium">Nâng cấp Pro</span>
                                </button>
                            )}
                        </nav>

                        <div className="mt-auto pt-6 border-t border-slate-800">
                            {!user.isPremium && (
                                <button 
                                    onClick={() => setShowPremium(true)} 
                                    className="w-full mb-4 flex items-center justify-center gap-2 p-3 rounded-lg bg-yellow-500/20 text-yellow-400 hover:bg-yellow-500/30 border border-yellow-500/50 font-bold text-sm transition"
                                >
                                    <i className="fa-solid fa-crown"></i>
                                    Nâng cấp Pro
                                </button>
                            )}
                            <div 
                                className="flex items-center gap-3 mb-3 cursor-pointer hover:bg-slate-800 p-2 rounded-lg transition" 
                                onClick={() => setShowAccount(true)}
                            >
                                <div className="w-8 h-8 rounded-full bg-indigo-500 flex items-center justify-center font-bold text-sm">
                                    {user.username[0].toUpperCase()}
                                </div>
                                <div className="overflow-hidden">
                                    <div className="font-bold text-sm truncate">{user.username}</div>
                                    <div className="text-xs text-slate-400">{user.isPremium ? 'Pro Plan' : 'Free Plan'}</div>
                                </div>
                            </div>
                            <button 
                                onClick={onLogout} 
                                className="text-red-400 hover:text-red-300 font-bold text-xs flex items-center gap-2 px-2"
                            >
                                <i className="fa-solid fa-right-from-bracket"></i> 
                                Đăng xuất
                            </button>
                        </div>
                    </div>

                    {/* MAIN CONTENT */}
                    <div className="flex-1 bg-slate-950 relative overflow-y-auto">
                        {view === 'dashboard' && (
                            <div className="p-8 animate-fade-in">
                                <h2 className="text-3xl font-bold mb-6">Thư viện bài học</h2>
                                {logs.length === 0 ? (
                                    <p className="text-slate-500 text-center py-12">Chưa có bài học nào. Tạo bài học đầu tiên trong AI Game Studio!</p>
                                ) : (
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                        {logs.map(l => (
                                            <div 
                                                key={l.id} 
                                                onClick={() => {setCurrentGame({ data: l.data, mode: l.mode }); setView('play');}} 
                                                className="glass-panel p-5 rounded-2xl cursor-pointer hover:border-indigo-500 transition hover:-translate-y-1 relative group"
                                            >
                                                <div className="flex justify-between items-center mb-3">
                                                    <span className="text-xs font-bold bg-slate-700 text-slate-300 px-2 py-1 rounded uppercase tracking-wider">
                                                        {l.mode}
                                                    </span>
                                                    <div className="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                        <button 
                                                            onClick={(e) => handleRename(l.id, l.customTitle || l.fileName, e)} 
                                                            className="text-slate-400 hover:text-white p-1" 
                                                            title="Đổi tên"
                                                        >
                                                            <i className="fa-solid fa-pen"></i>
                                                        </button>
                                                        <button 
                                                            onClick={(e) => handleDelete(l.id, e)} 
                                                            className="text-slate-400 hover:text-red-500 p-1" 
                                                            title="Xóa"
                                                        >
                                                            <i className="fa-solid fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                <h3 className="font-bold text-lg truncate mb-1">{l.customTitle || l.fileName}</h3>
                                                <div className="flex justify-between text-xs text-slate-400">
                                                    <span>{l.data.length} câu</span>
                                                    <span>{new Date(l.createdAt).toLocaleDateString('vi-VN')}</span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}

                        {view === 'create' && <CreateGameView onCreate={handleCreate} loading={loading} isPremium={user.isPremium} />}
                        
                        {view === 'play' && currentGame && (
                            <GamePlayer game={currentGame} onBack={() => setView('dashboard')} isPremium={user.isPremium} />
                        )}
                    </div>

                    {showAccount && <AccountModal user={user} onClose={() => setShowAccount(false)} />}
                    {showPremium && <PremiumModal user={user} onClose={() => setShowPremium(false)} onUpgrade={handleUpgrade} />}
                </div>
            );
        };

        // CREATE GAME VIEW
        const CreateGameView = ({ onCreate, loading, isPremium }) => {
            const [file, setFile] = useState(null);
            const [mode, setMode] = useState('multiple_choice');
            const [num, setNum] = useState(10);
            const [focus, setFocus] = useState('');

            const modes = [
                { id: 'multiple_choice', label: 'Trắc nghiệm', icon: 'fa-list-ul', free: true },
                { id: 'flashcard', label: 'Flashcard', icon: 'fa-clone', free: true },
                { id: 'true_false', label: 'Đúng / Sai', icon: 'fa-check-double', free: false },
                { id: 'fill_blank', label: 'Điền từ', icon: 'fa-pen-to-square', free: false },
                { id: 'qa', label: 'Hỏi đáp', icon: 'fa-comments', free: false }
            ];

            return (
                <div className="p-8 h-full flex items-center justify-center animate-fade-in">
                    {loading ? (
                        <div className="text-center">
                            <div className="w-16 h-16 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                            <p className="text-lg">AI đang đọc tài liệu...</p>
                        </div>
                    ) : (
                        <div className="glass-panel p-8 rounded-3xl w-full max-w-2xl border-t border-indigo-500/50 shadow-2xl">
                            <h2 className="text-3xl font-bold mb-6 text-center">AI Game Studio</h2>
                            
                            <div className="space-y-6">
                                <div>
                                    <label className="block text-sm font-bold text-slate-400 mb-2">1. Upload PDF</label>
                                    <div className="border-2 border-dashed border-slate-600 hover:border-indigo-500 bg-slate-900/50 rounded-xl p-8 text-center relative group cursor-pointer transition">
                                        <input 
                                            type="file" 
                                            accept=".pdf" 
                                            onChange={e => setFile(e.target.files[0])} 
                                            className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"
                                        />
                                        <i className="fa-solid fa-cloud-arrow-up text-4xl text-indigo-400 mb-2"></i>
                                        <p className="text-sm text-slate-200">{file ? file.name : "Chọn file PDF"}</p>
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-sm font-bold text-slate-400 mb-2">2. Chọn Mode</label>
                                    <div className="grid grid-cols-3 gap-2">
                                        {modes.map(mo => (
                                            <button
                                                key={mo.id}
                                                onClick={() => !(!mo.free && !isPremium) && setMode(mo.id)}
                                                disabled={!mo.free && !isPremium}
                                                className={`p-3 rounded-xl border text-xs font-bold flex flex-col items-center gap-2 relative transition ${
                                                    mode === mo.id
                                                        ? 'border-indigo-500 bg-indigo-500/20 text-white'
                                                        : 'border-slate-700 bg-slate-800/50 text-slate-400 hover:border-slate-600'
                                                } ${!mo.free && !isPremium ? 'opacity-50 cursor-not-allowed' : ''}`}
                                            >
                                                <i className={`fa-solid ${mo.icon} text-lg`}></i>
                                                {mo.label}
                                                {!mo.free && !isPremium && (
                                                    <div className="absolute inset-0 bg-black/60 flex items-center justify-center rounded-xl">
                                                        <i className="fa-solid fa-lock text-yellow-500"></i>
                                                    </div>
                                                )}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {isPremium && (
                                    <div className="p-4 bg-slate-800/50 rounded-xl border border-yellow-500/30">
                                        <div className="flex items-center gap-2 mb-3 text-yellow-400 font-bold text-sm">
                                            <i className="fa-solid fa-sliders"></i> Tùy chỉnh (Pro)
                                        </div>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div>
                                                <label className="text-xs text-slate-400 block mb-1">Số câu ({num})</label>
                                                <input 
                                                    type="range" 
                                                    min="5" 
                                                    max="20" 
                                                    value={num} 
                                                    onChange={e => setNum(e.target.value)} 
                                                    className="w-full accent-yellow-500"
                                                />
                                            </div>
                                            <div>
                                                <label className="text-xs text-slate-400 block mb-1">Trọng tâm</label>
                                                <input 
                                                    type="text" 
                                                    placeholder="VD: Định nghĩa..." 
                                                    value={focus} 
                                                    onChange={e => setFocus(e.target.value)} 
                                                    className="w-full bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-white outline-none focus:border-indigo-500"
                                                />
                                            </div>
                                        </div>
                                    </div>
                                )}

                                <button 
                                    onClick={() => file && onCreate(file, mode, num, focus)} 
                                    disabled={!file}
                                    className={`w-full py-4 rounded-xl font-bold text-lg shadow-lg transition ${
                                        file ? 'vibe-gradient hover:scale-[1.02] active:scale-95' : 'bg-slate-800 text-slate-500 cursor-not-allowed'
                                    }`}
                                >
                                    Khởi Tạo
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // GAME PLAYER
        const GamePlayer = ({ game, onBack, isPremium }) => {
            const { data, mode } = game;
            
            // Try to get game components from window object
            let MCQGame, TrueFalseGame, FlashcardGame, FillBlankGame, QAGame;
            try {
                if (window.GameComponents) {
                    MCQGame = window.GameComponents.MCQGame;
                    TrueFalseGame = window.GameComponents.TrueFalseGame;
                    FlashcardGame = window.GameComponents.FlashcardGame;
                    FillBlankGame = window.GameComponents.FillBlankGame;
                    QAGame = window.GameComponents.QAGame;
                }
            } catch (e) {
                console.error('Error accessing GameComponents:', e);
            }

            return (
                <div className="p-8 flex flex-col items-center h-full overflow-y-auto animate-fade-in">
                    <div className="w-full max-w-3xl flex items-center mb-6">
                        <button 
                            onClick={onBack} 
                            className="text-slate-400 hover:text-white flex items-center gap-2 transition"
                        >
                            <i className="fa-solid fa-arrow-left"></i> Quay lại
                        </button>
                    </div>
                    
                    {mode === 'flashcard' && FlashcardGame ? <FlashcardGame data={data} /> : null}
                    {mode === 'multiple_choice' && MCQGame ? <MCQGame data={data} isPremium={isPremium} /> : null}
                    {mode === 'true_false' && TrueFalseGame ? <TrueFalseGame data={data} isPremium={isPremium} /> : null}
                    {mode === 'fill_blank' && FillBlankGame ? <FillBlankGame data={data} /> : null}
                    {mode === 'qa' && QAGame ? <QAGame data={data} /> : null}
                    
                    {(!MCQGame && !TrueFalseGame && !FlashcardGame && !FillBlankGame && !QAGame) && (
                        <div className="text-red-400 text-center py-12">
                            <p className="mb-4">⚠️ Không tìm thấy Game Components</p>
                            <p className="text-sm text-slate-400">GameComponents.js có thể chưa tải xong</p>
                        </div>
                    )}
                </div>
            );
        };

        // MAIN APP
        function App() {
            const [user, setUser] = useState(null);
            const [token, setToken] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const checkAuth = () => {
                    const savedUser = localStorage.getItem('vibe_user');
                    const savedToken = localStorage.getItem('vibe_token');
                    if (savedUser && savedToken) {
                        try {
                            setUser(JSON.parse(savedUser));
                            setToken(savedToken);
                        } catch (e) {
                            localStorage.removeItem('vibe_user');
                            localStorage.removeItem('vibe_token');
                        }
                    }
                    setLoading(false);
                };
                checkAuth();
            }, []);

            const handleLogin = (u, t) => {
                setUser(u);
                setToken(t);
            };

            const handleLogout = () => {
                setUser(null);
                setToken(null);
                localStorage.removeItem('vibe_user');
                localStorage.removeItem('vibe_token');
            };

            if (loading) {
                return (
                    <div className="h-screen w-screen flex items-center justify-center bg-slate-950">
                        <div className="text-center">
                            <div className="w-12 h-12 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                            <p>Đang tải...</p>
                        </div>
                    </div>
                );
            }

            if (!user || !token) {
                return <AuthScreen onLogin={handleLogin} />;
            }

            return <Dashboard user={user} token={token} setUser={setUser} onLogout={handleLogout} />;
        }

        // RENDER
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>